var scene=new THREE.Scene,renderer,camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);camera.position.z=360,camera.position.x=0,camera.position.y=0,renderer=new THREE.WebGLRenderer,renderer.setSize(window.innerWidth,window.innerHeight);const wrapper=document.querySelector("#webgl");wrapper.appendChild(renderer.domElement);const geometry=new THREE.BufferGeometry,img=new Image;img.src="img/yoko_2k_min.png",img.crossOrigin="anonymous",img.addEventListener("load",()=>{var h=z(img,img.width,img.height,2),t,u,r,d,l,a,e,n,m,g,_,p,c;const A=new THREE.BufferAttribute(new Float32Array(h.position),3),C=new THREE.BufferAttribute(new Float32Array(h.color),3),E=new THREE.BufferAttribute(new Float32Array(h.alpha),1),b=[],i=h.position.length/3;for(let e=0;e<i;e++)b.push((Math.random()-1)*2,(Math.random()-1)*2);const k=new THREE.BufferAttribute(new Float32Array(b),2),v=[];for(let e=0;e<i;e++)v.push(1);const S=new THREE.BufferAttribute(new Float32Array(v),1);geometry.setAttribute("position",A),geometry.setAttribute("color",C),geometry.setAttribute("alpha",E),geometry.setAttribute("rand",k),geometry.setAttribute("flag",S);const R=new THREE.RawShaderMaterial({vertexShader:document.querySelector("#js-vertex-shader").textContent,fragmentShader:document.querySelector("#js-fragment-shader").textContent,uniforms:{u_ratio:{type:"f",value:0},u_time:{type:"f",value:0},move_param:{type:"i",value:0}},transparent:!0});t=new THREE.Points(geometry,R),t.position.x=0,scene.add(t),u=!1,r=!1;const o=t.geometry.attributes.alpha.array,s=t.geometry.attributes.flag.array;L(3),window.setTimeout(T,4*2e3),window.setTimeout(f,4*2e3),d=t.geometry.attributes.position,l=new THREE.Vector2,a=new THREE.Vector2,e=new THREE.Vector2,n=new THREE.Vector2;function f(){r===!1?r=!0:r===!0&&(r=!1)}renderer.domElement.addEventListener("mousedown",M),renderer.domElement.addEventListener("mouseup",F),g=0,p=0;function w(){_=setTimeout(function(){g=Date.now()-m+p,w()},10),c=g/1e3}function M(e){e.preventDefault(),a.x=e.clientX-window.innerWidth/2,a.y=-(e.clientY-window.innerHeight/2),m=Date.now(),w()}function F(E){E.preventDefault();const o=t.geometry.attributes.position.array;if(l.x=E.clientX-window.innerWidth/2,l.y=-(E.clientY-window.innerHeight/2),e.x=l.x-a.x,e.y=l.y-a.y,n.x=Math.abs(e.x),n.y=Math.abs(e.y),u==!0){for(let t=0;t<i;t++){x=d.getX(t)*(500/360)-8,y=d.getY(t)*(500/360)+8;var A={x:d.getX(t),y:d.getY(t)},v,h,b,z,S,M,F,O,w,j,C,k={x1:camera.position.x,y1:camera.position.y,z1:camera.position.z,x2:camera.rotation.x,y2:camera.rotation.y},T=Math.sqrt(Math.pow(x-a.x,2)+Math.pow(y-a.y,2));if(s[t]===1)if(T<10/(c*3)){if(s[t]=0,e.x>0&n.y<20)v=1,h=0,b=Math.floor(Math.random()*50+1-40)+40;else if(e.x<0&n.y<20)v=-1,h=0,b=Math.floor(Math.random()*50+1-40)+40;else if(e.y>0&n.y>=20)v=0,h=1,b=Math.floor(Math.random()*50+1-40)+40;else if(e.y<0&n.y>=20)v=0,h=-1,b=Math.floor(Math.random()*20+1-10)+10;else if(n.x<3|n.y<3)return;z=b*v,S=b*h,M=o[3*t]+z+e.x/(c*20),F=o[3*t+1]+S+e.y/(c*20),O=new TWEEN.Tween(A),O.to({x:M,y:F,z:s[t]},c*1e4),O.easing(TWEEN.Easing.Quadratic.Out),O.onUpdate(function(e){o[3*t]=e.x,o[3*t+1]=e.y,s[t]=0}),w=new TWEEN.Tween(A),w.to({x:o[3*t],y:o[3*t+1],z:s[t]},5e3),w.easing(TWEEN.Easing.Quadratic.Out),w.delay(500),w.onUpdate(function(e){o[3*t]=e.x,o[3*t+1]=e.y,s[t]=1}),j=new TWEEN.Tween(k),j.to({x1:80*v,y1:100*(-1*h),z1:300,x2:.3*h,y2:.1*v},5e3),j.delay(2e3),j.onUpdate(function(e){camera.position.x=e.x1,camera.position.y=e.y1,camera.position.z=e.z1,camera.rotation.x=e.x2,camera.rotation.y=e.y2}),C=new TWEEN.Tween(k),C.to({x1:0,y1:0,z1:350,x2:0,y2:0},5e3),C.delay(2e3),C.onUpdate(function(e){camera.position.x=e.x1,camera.position.y=e.y1,camera.position.z=e.z1,camera.rotation.x=e.x2,camera.rotation.y=e.y2}),O.chain(w),j.chain(C),O.start(),r===!0&&(j.start(),f())}}window.setTimeout(f,5e3+5e3)}clearTimeout(_),p+=Date.now()-m,g=0,p=0}function T(){u==!1?u=!0:u=!1}O();function z(h,d,l,o){const s=document.createElement("canvas"),i=s.getContext("2d"),t=d,n=l;s.width=t,s.height=n,i.drawImage(h,0,0);const u=i.getImageData(0,0,t,n).data,a=[],r=[],c=[];for(let s=0;s<n;s+=o)for(let i=0;i<t;i+=o){const l=(s*t+i)*4,d=i-t/2,h=-(s-n/2),m=0;var e=[0,255];const f=e[Math.floor(Math.random()*e.length)],p=e[Math.floor(Math.random()*e.length)],g=e[Math.floor(Math.random()*e.length)],v=u[l+3]/255;a.push(d,h,m),r.push(f,p,g),c.push(v)}return{position:a,color:r,alpha:c}}function D(n){for(var e=0,t;e<i;e++)o[e]>0&&(o[e]=.5**6);for(e=0;e<n;e++)for(t=0;t<i;t++)random=t+Math.floor(Math.random()*2)+1,o[random]>0&&(o[random]=.5**(e+7))}function N(t){for(let a=0;a<i;a++){var n={x:o[a],y:s[a]},e=new TWEEN.Tween(n);e.to({x:1,y:1},3e3);for(j=0;j<t;j++)o[a]===.5**(j+6)&&(e.delay(j*2e3),e.start());e.onUpdate(function(e){o[a]=e.x,s[a]=e.y})}}function L(e){D(e),N(e+1)}function O(){requestAnimationFrame(O),renderer.render(scene,camera),t.material.uniforms.u_time.value+=.1,TWEEN.update(),t.geometry.attributes.alpha.needsUpdate=!0,t.geometry.attributes.position.needsUpdate=!0,t.geometry.attributes.flag.needsUpdate=!0}})